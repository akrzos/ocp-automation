---
- name: set workdir
  set_fact:
    workdir: "{{ GOPATH }}/src/github.com/openshift/installer"

- name: ensure that .kube dir exists on controller
  file:
    path: /home/core/.kube
    state: directory

- name: copy the kubeconfig to controller node
  copy:
    src: "{{ workdir }}/auth/kubeconfig"
    dest: /home/core/.kube/config

- name: copy perf private key to controller host
  copy:
    src: /root/.ssh/id_rsa
    dest: /home/core/.ssh/id_rsa
    mode: 0600

- name: copy ssh config
  copy:
    src: config
    dest: /home/core/.ssh/config
    mode: 0600

- name: copy clusterloader binary
  copy:
    src: /usr/libexec/atomic-openshift/extended.test
    dest: /home/core/extended.test
    mode: 0755

- name: check if cluster loader binary exists
  stat:
    path: /home/core/extended.test
  register: extended

- name: fail if the extended.test binary doesn't exist
  fail:
    msg: Please make sure extended.test exists on {{ ansible_inventory_host }} at /usr/libexec/atomic-openshift/extended.test.
  when: extended.stat.exists == False 

- name: pbench-controller image
  shell: podman pull docker.io/ravielluri/image:controller

- name: nodes
  shell: oc get nodes | awk 'NR>1 {print $1}'
  register: ocp_nodes

- name: add nodes to group
  add_host: name={{ item }} groups=nodes
  with_items:
    - "{{ ocp_nodes.stdout_lines }}"
